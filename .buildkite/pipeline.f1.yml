# Consolidate the common configuration for reuse across multiple steps.
definitions:
  # Configure some default step values.
  step-defaults: &step-defaults
    timeout_in_minutes: 15
    retry:
      manual:
        permit_on_passed: true
  plugins:
    ecr: &ecr
      ecr#v2.7.0:
        login: true
        no-include-email: true
    forumone-extract: &forumone-extract
      forumone/extract#v0.2.0:
        image: ${ECR_NAMESPACE}:${BUILDKITE_PIPELINE_SLUG}-${BUILDKITE_COMMIT}
        from: /var/www/html
        to: ${ARTIFACT_LOCATION}
  # This will only trigger when the build branch is: live, main, or integration
  # and NOT a PR
  # build.pull_request.base_branch == null ; refers to the PR code is being merged into
  deploy-release-conditional: &deploy-release-conditional
    if: |
      build.pull_request.base_branch == null
      && (
        build.branch == 'live'
        || build.branch == 'main'
        || build.branch == 'integration'
      )
steps:
  - label: ":capistrano: Deploy"
    key: "deploy"
    <<: *step-defaults
    concurrency: 1
    <<: *deploy-release-conditional
    concurrency_group: '$BUILDKITE_PIPELINE_SLUG/$BUILDKITE_BRANCH/deploy'
    plugins:
      # Log into ECR for this build step to access prebuilt images.
      - *ecr

      # Download the prebuilt image and extract project files to the
      # local filesystem for further operations.
      - *forumone-extract

      # Execute a Capistrano deployment using the defined branch to
      # environment mapping.
      - forumone/capistrano#v1.0.0:
          require-stage: true
          branches:
            integration: dev
            main: stage
            live: prod
